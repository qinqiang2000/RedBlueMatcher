# 税号过滤功能使用说明

## 功能概述

新增 `--seller` 和 `--buyer` 命令行参数，支持仅处理特定销方税号和购方税号组合的负数单据匹配。

**使用场景：** 临时测试特定税号组合的匹配情况

## 参数说明

### --seller TAXNO
- **作用：** 指定销方税号
- **类型：** 字符串
- **必需：** 否（可选参数）
- **限制：** 必须同时指定 `--buyer` 才生效

### --buyer TAXNO
- **作用：** 指定购方税号
- **类型：** 字符串
- **必需：** 否（可选参数）
- **限制：** 必须同时指定 `--seller` 才生效

## 使用示例

### 示例 1：仅处理特定税号组合
```bash
python red_blue_matcher.py --seller 91110000XXX --buyer 91120000YYY
```

### 示例 2：结合测试模式使用
```bash
# 处理特定税号组合的前 100 条负数单据
python red_blue_matcher.py --seller 91110000XXX --buyer 91120000YYY --test-limit 100
```

### 示例 3：指定算法和输出文件
```bash
python red_blue_matcher.py \
  --seller 91110000XXX \
  --buyer 91120000YYY \
  --algorithm ffd \
  --output test_results.xlsx
```

### 示例 4：只指定一个参数（无效）
```bash
# 警告：只指定 --seller 参数会被忽略，仍处理全部负数单据
python red_blue_matcher.py --seller 91110000XXX
```

输出：
```
⚠️  警告: --seller 和 --buyer 必须同时指定才生效，已忽略过滤条件
```

### 示例 5：不指定参数（默认行为）
```bash
# 处理全部负数单据（默认行为）
python red_blue_matcher.py
```

## 参数组合验证规则

| --seller | --buyer | 结果 |
|----------|---------|------|
| ✓ 指定   | ✓ 指定  | ✅ **生效** - 仅处理该税号组合的负数单据 |
| ✓ 指定   | ✗ 未指定 | ⚠️ **忽略** - 显示警告，处理全部负数单据 |
| ✗ 未指定  | ✓ 指定  | ⚠️ **忽略** - 显示警告，处理全部负数单据 |
| ✗ 未指定  | ✗ 未指定 | ✅ **默认** - 处理全部负数单据 |

## 日志输出示例

### 成功启用税号过滤
```
[2025-12-14 10:30:00] 启用税号过滤: 销方=91110000XXX, 购方=91120000YYY
============================================================
负数发票自动匹蓝算法 - 开始执行
[2025-12-14 10:30:01] 使用匹配策略: greedy_large
============================================================
[2025-12-14 10:30:01] 过滤条件: 销方税号=91110000XXX, 购方税号=91120000YYY
[2025-12-14 10:30:01] 加载了 15 条待处理负数单据明细
```

### 参数验证警告
```
[2025-12-14 10:30:00] ⚠️  警告: --seller 和 --buyer 必须同时指定才生效，已忽略过滤条件
============================================================
负数发票自动匹蓝算法 - 开始执行
[2025-12-14 10:30:01] 使用匹配策略: greedy_large
============================================================
[2025-12-14 10:30:01] 加载了 1250 条待处理负数单据明细
```

## 实现细节

### SQL 过滤逻辑
当同时指定 `--seller` 和 `--buyer` 时，SQL 查询会添加以下过滤条件：

```sql
WHERE b.fbillproperties = '-1'
  AND b.fconfirmstate = '0'
  AND b.fsalertaxno = '91110000XXX'  -- 销方税号过滤
  AND b.fbuyertaxno = '91120000YYY'  -- 购方税号过滤
ORDER BY b.fid, i.fentryid
```

### 代码修改位置
1. `parse_arguments()` - 添加参数定义
2. `load_negative_items()` - 添加 SQL 过滤条件
3. `run_matching_algorithm()` - 传递参数
4. `main()` - 参数验证和传递

## 注意事项

1. **SQL 注入风险**
   - 当前使用字符串拼接实现，适用于临时测试场景
   - 如需长期使用，建议改为参数化查询以防止 SQL 注入

2. **参数验证**
   - 仅当两个参数都提供时才启用过滤
   - 单独提供一个参数会显示警告并忽略过滤

3. **性能影响**
   - 使用税号过滤可大幅减少加载的负数单据数量
   - 适合快速测试特定税号组合的匹配效果

4. **与其他参数兼容**
   - 可与 `--test-limit`、`--algorithm`、`--output` 参数组合使用
   - 不影响现有功能

## 常见问题

### Q1: 为什么必须同时指定两个参数？
A: 发票匹配的业务逻辑要求销方和购方必须完全匹配，单独指定一个税号没有实际意义。

### Q2: 如何查看当前可用的税号？
A: 可以先运行不带过滤参数的命令，查看输出结果中的税号信息，然后选择需要测试的税号组合。

### Q3: 过滤后没有找到负数单据怎么办？
A: 检查：
1. 税号是否输入正确
2. 该税号组合是否确实有待处理的负数单据（fbillproperties='-1' AND fconfirmstate='0'）
3. 查看日志输出确认过滤条件是否生效

### Q4: 可以同时过滤多个税号组合吗？
A: 当前版本不支持，只能指定单一的销购方税号组合。如需处理多个税号组合，需要多次运行命令。

## 测试建议

```bash
# 1. 测试仅指定 --seller（应忽略过滤）
python red_blue_matcher.py --seller 91110000XXX

# 2. 测试仅指定 --buyer（应忽略过滤）
python red_blue_matcher.py --buyer 91120000YYY

# 3. 测试同时指定两个参数（应生效）
python red_blue_matcher.py --seller 91110000XXX --buyer 91120000YYY

# 4. 测试不指定参数（应处理全部）
python red_blue_matcher.py

# 5. 结合 --test-limit 测试
python red_blue_matcher.py --seller 91110000XXX --buyer 91120000YYY --test-limit 10
```
