# Optimization Implementation Plan: Minimize Red Tickets

## Goal Description
The objective is to significantly reduce the number of Red Tickets (Blue Invoices used) generated by the matching algorithm. The current implementation creates ~6000+ red tickets. We aim to reduce this by packing negative items more efficiently into fewer, larger blue invoices.

## User Review Required
> [!IMPORTANT]
> **Priority Shift**: This change strictly enforces **Priority 1 (Minimize Blue Invoices)** over **Priority 2 (Full Line Flush)**.
> Previously, the algorithm would skip a large invoice to use a smaller invoice if it matched the amount exactly (Exact Match).
> The new algorithm will **always** choose the largest available invoice that can cover the negative amount, even if it leaves a small remainder on that large invoice. This is mathematically required to minimize the total number of blue invoices used (Bin Packing strategy).

## Proposed Changes

### Logic Improvements

#### 1. Sort Negative Items Decrease
**File**: [red_blue_matcher.py](file:///Users/qinqiang02/colab/codespace/python/RedBlueMatcher/red_blue_matcher.py)
**Why**: In Bin Packing problems (packing negative items into blue invoices), processing **Largest Items First** (First Fit Decreasing) yields significantly better results than random order.
**Change**:
- In [match_group_worker](file:///Users/qinqiang02/colab/codespace/python/RedBlueMatcher/red_blue_matcher.py#525-590), after creating `NegItem` objects, sort them by `abs(famount)` descending.

#### 2. Replace Exact Match with Vectorized First Fit
**File**: [red_blue_matcher.py](file:///Users/qinqiang02/colab/codespace/python/RedBlueMatcher/red_blue_matcher.py)
**Refactor**: [match_single_negative](file:///Users/qinqiang02/colab/codespace/python/RedBlueMatcher/red_blue_matcher.py#754-942)
**Why**:
- The current [find_exact_match](file:///Users/qinqiang02/colab/codespace/python/RedBlueMatcher/red_blue_matcher.py#627-660) function searches for an invoice with `balance == amount`. Since candidates are sorted by Size Descending, an "exact match" is likely a smaller invoice found later in the list. Picking it prevents the use of the larger invoices at the top of the list, leading to fragmentation.
- To minimize tickets, we must use the **Largest Available** invoice that fits (which is the first one in the sorted list).
- To maintain performance, we will replace [find_exact_match](file:///Users/qinqiang02/colab/codespace/python/RedBlueMatcher/red_blue_matcher.py#627-660) with `find_first_fit_vectorized` which finds the *first* invoice where `balance >= amount`.

### [red_blue_matcher.py](file:///Users/qinqiang02/colab/codespace/python/RedBlueMatcher/red_blue_matcher.py)

#### [MODIFY] [red_blue_matcher.py](file:///Users/qinqiang02/colab/codespace/python/RedBlueMatcher/red_blue_matcher.py)

- **Update [match_group_worker](file:///Users/qinqiang02/colab/codespace/python/RedBlueMatcher/red_blue_matcher.py#525-590)**:
  - Add sorting of `neg_items`: `neg_items.sort(key=lambda x: abs(x.famount), reverse=True)`

- **Add `find_first_sufficient_match`**:
  - New numpy-based function: `np.where(amounts_scaled >= target_scaled)[0]`. return `[0]`.
  - This effectively finds the first (largest) invoice that can fully cover the target amount.

- **Update [match_single_negative](file:///Users/qinqiang02/colab/codespace/python/RedBlueMatcher/red_blue_matcher.py#754-942)**:
  - Replace call to [find_exact_match](file:///Users/qinqiang02/colab/codespace/python/RedBlueMatcher/red_blue_matcher.py#627-660) with `find_first_sufficient_match`.
  - Update the logic to handle the returned index (it's the same logic as the "greedy loop" but jumping directly to the winner).

## Verification Plan

### Automated Tests
1. **Benchmark Run**:
   - Run `python benchmark.py` (if available, or create a small test script) using a subset of the data.
   - Or rerun the full process on the 500-item test set if [start_full_run_unbuffered.sh](file:///Users/qinqiang02/colab/codespace/python/RedBlueMatcher/start_full_run_unbuffered.sh) is too slow.
   - For this task, since the user provided [start_full_run_unbuffered.sh](file:///Users/qinqiang02/colab/codespace/python/RedBlueMatcher/start_full_run_unbuffered.sh), we can try running that or a smaller equivalent.

2. **Metric Verification**:
   - Run `python count_red_invoices.py output/[new_result].xlsx`.
   - Compare the count against the previous run (6000+).

### Manual Verification
- Inspect the logs to ensure "Largest Items" are being processed first.
- Inspect the output to confirm that big blue invoices are being "filled up" with multiple negative items.
